<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>AegisAI – Policy Brain</title>
        <style>
            body { font-family: system-ui, Arial; max-width: 800px; margin: 24px auto; }
            textarea, input, select, button { font: inherit; }
            .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin: 12px 0; }
            .row { display: flex; gap: 8px; align-items: center; }
            .row > * { flex: 1; }
            pre { white-space: pre-wrap; }
        </style>
    </head>
    <body>
        <h1>AegisAI</h1>

        <div class="card">
            <h3>Policy Question (/ask)</h3>
            <div class="row">
            <input id="grade" placeholder="Grade (e.g., G7 or G10)" value="G7" />
            <input id="question" placeholder="Ask a policy question..." />
            <button onclick="ask()">Ask</button>
            </div>
            <pre id="askOut"></pre>
        </div>

        <div class="card">
            <h3>Analyze Logs (/analyze)</h3>
            <p>Paste JSON array of events or click “Load sample from server”.</p>
            <div class="row">
            <button onclick="loadSample()">Load sample from /data/logs.jsonl</button>
            <button onclick="analyze()">Analyze</button>
            </div>
            <textarea id="logs" rows="8" placeholder='[{"event_id":"...", ...}]'></textarea>
            <pre id="anaOut"></pre>
        </div>

        <div class="card">
            <h3>Narrative (/narrative)</h3>
            <p>Paste the <code>anomalies</code> from /analyze, we’ll wrap them for you.</p>
            <textarea id="narIn" rows="6" placeholder='{"anomalies":[...]}'></textarea>
            <button onclick="narrative()">Generate Narrative</button>
            <pre id="narOut"></pre>
        </div>

        <script>
            const API = ''; // same-origin. If your API is elsewhere, set e.g. 'http://localhost:8000'

            async function ask(){
            const grade = document.getElementById('grade').value.trim();
            const question = document.getElementById('question').value.trim();
            const r = await fetch(API + '/ask', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ query: question, user_grade: grade })
            });
            document.getElementById('askOut').textContent = JSON.stringify(await r.json(), null, 2);
            }

            async function loadSample(){
            // fetch the raw JSONL file and convert to array
            const res = await fetch('/data/logs.jsonl');
            const text = await res.text();
            const lines = text.trim().split(/\r?\n/).filter(Boolean);
            const arr = lines.map(l => JSON.parse(l));
            document.getElementById('logs').value = JSON.stringify(arr, null, 2);
            }

            async function analyze(){
            let arr;
            try { arr = JSON.parse(document.getElementById('logs').value); }
            catch(e){ alert('Provide a JSON array of events'); return; }
            const r = await fetch(API + '/analyze', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ events: arr })
            });
            document.getElementById('anaOut').textContent = JSON.stringify(await r.json(), null, 2);
            }

            async function narrative(){
            let input;
            try { input = JSON.parse(document.getElementById('narIn').value); }
            catch(e){ alert('Provide JSON with anomalies or copy from Analyze output'); return; }
            // If user pasted {"anomalies":[...]}, reshape into expected payload
            const items = (input.anomalies || []).map(a => ({
                event: { event_id: a.event_id, role: '', timestamp: '', action: '' },
                signals: a.signals || [],
                risk_score: a.risk_score || 0
            }));
            const r = await fetch(API + '/narrative', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ items })
            });
            document.getElementById('narOut').textContent = JSON.stringify(await r.json(), null, 2);
            }
        </script>
    </body>
</html>
