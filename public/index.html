<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AegisAI — Policy Copilot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, Arial, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
      .row { display: flex; gap: 0.75rem; }
      textarea, input { width: 100%; padding: 0.6rem; }
      button { padding: 0.6rem 1rem; cursor: pointer; }
      .panel { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
      .small { color: #666; font-size: 0.9rem; }
      ul { margin: 0.5rem 0 0 1.25rem; }
      code { background: #f7f7f7; padding: 0.1rem 0.3rem; border-radius: 4px; }
      .badge { display: inline-block; padding: 2px 6px; border: 1px solid #ccc; border-radius: 999px; font-size: 0.8rem; margin-left: 6px; }
    </style>
  </head>
  <body>
    <h1>AegisAI — Policy Copilot</h1>

    <div class="panel">
      <div class="row">
        <input id="grade" placeholder="Grade (e.g., Cabin Crew / Pilot / HR Manager)" />
      </div>
      <div class="row" style="margin-top:0.5rem;">
        <textarea id="q" rows="3" placeholder="Ask a policy question..."></textarea>
      </div>
      <div class="row" style="margin-top:0.5rem;">
        <button id="askBtn">Ask</button>
        <span id="status" class="small"></span>
      </div>
    </div>

    <div id="result" class="panel" style="display:none;">
      <h3>Answer</h3>
      <div id="answer"></div>
      <div id="meta" class="small"></div>

      <h3 style="margin-top:1rem;">Citations</h3>
      <ul id="citations"></ul>

      <h3 style="margin-top:1rem;">Highlights</h3>
      <ul id="highlights"></ul>

      <details style="margin-top:1rem;">
        <summary>Raw JSON</summary>
        <pre id="raw" style="white-space:pre-wrap;"></pre>
      </details>
    </div>

    <script>
      // If your API is same-origin, leave empty. Else set to your base URL.
      const API = ''; // e.g. 'https://yourapp.azurewebsites.net'

      const el = (id) => document.getElementById(id);

      function safeArray(x) {
        if (Array.isArray(x)) return x;
        return [];
      }

      function text(t) {
        return (t === null || t === undefined) ? '' : String(t);
      }

      function renderResult(data) {
        el('result').style.display = 'block';
        el('raw').textContent = JSON.stringify(data, null, 2);

        // v1/v2 compatibility — answer is the same key
        el('answer').textContent = text(data.answer);

        // Optional meta line (confidence, correlation id, flags)
        const metaBits = [];
        if (typeof data.confidence === 'number') metaBits.push(`confidence: ${(data.confidence*100).toFixed(0)}%`);
        if (data.correlation_id) metaBits.push(`corr: ${data.correlation_id}`);
        if (data.restricted_probe) metaBits.push('restricted-probe');
        if (safeArray(data.risk_reasons).length) metaBits.push(`reasons: ${data.risk_reasons.join('; ')}`);
        el('meta').textContent = metaBits.join('  •  ');

        // Citations (snake_case keys per backend)
        const cites = safeArray(data.citations || data.Citations);
        const ulC = el('citations');
        ulC.innerHTML = '';
        if (cites.length === 0) {
          ulC.innerHTML = '<li class="small">None</li>';
        } else {
          cites.forEach(c => {
            const li = document.createElement('li');
            const title = c.title ? ` — ${c.title}` : '';
            const grades = Array.isArray(c.allowed_grades) ? ` <span class="badge">grades: ${c.allowed_grades.join(', ')}</span>` : '';
            const vis = c.visibility ? ` <span class="badge">${c.visibility}</span>` : '';
            li.innerHTML = `<code>[${c.policy_id}/${c.clause_id}]</code>${title} — ${c.section || ''}${vis}${grades}`;
            ulC.appendChild(li);
          });
        }

        // Highlights
        const hl = safeArray(data.highlights || data.Highlights);
        const ulH = el('highlights');
        ulH.innerHTML = '';
        if (hl.length === 0) {
          ulH.innerHTML = '<li class="small">None</li>';
        } else {
          hl.forEach(h => {
            const li = document.createElement('li');
            li.innerHTML = `<code>[${h.policy_id}/${h.clause_id}]</code> ${h.snippet ? h.snippet : ''}`;
            ulH.appendChild(li);
          });
        }
      }

      async function doAsk() {
        el('status').textContent = 'Asking…';
        el('result').style.display = 'none';

        const payload = {
          query: el('q').value.trim(),
          user_grade: el('grade').value.trim() || null
        };

        try {
          const res = await fetch(`${API}/ask`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || `${res.status} ${res.statusText}`);
          }
          const data = await res.json();
          renderResult(data);
          el('status').textContent = 'Done';
        } catch (e) {
          el('status').textContent = 'Error';
          el('result').style.display = 'block';
          el('answer').textContent = '';
          el('citations').innerHTML = '';
          el('highlights').innerHTML = '';
          el('raw').textContent = String(e);
        }
      }

      el('askBtn').addEventListener('click', doAsk);
      // Optional: submit on Ctrl+Enter in textarea
      el('q').addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' && (ev.ctrlKey || ev.metaKey)) {
          doAsk();
        }
      });
    </script>
  </body>
</html>
